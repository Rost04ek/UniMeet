{% extends "base.html" %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="event-detail">
        <div class="event-detail-header">
            <span class="event-category">{{ event.category_name }}</span>
            <span class="event-status status-{{ event.status }}">{{ event.status|translate_status }}</span>
        </div>
        
        <h1>{{ event.title }}</h1>
        
        <div class="event-meta">
            <div class="meta-item">
                <strong>üìÖ –î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è:</strong> {{ event.event_date.strftime('%d.%m.%Y –æ %H:%M') }}
            </div>
            <div class="meta-item">
                <strong>üìç –ú—ñ—Å—Ü–µ:</strong> {{ event.location }}
                {% if event.is_online and event.online_link %}
                    <br>
                    <strong>üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è:</strong> <a href="{{ event.online_link }}" target="_blank" rel="noopener noreferrer">{{ event.online_link }}</a>
                {% endif %}
            </div>
            <div class="meta-item">
                <strong>üë§ –û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä:</strong> {{ event.organizer_name }} ({{ event.organizer_email }})
            </div>
            <div class="meta-item">
                <strong>üìù –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –¥–æ:</strong> {{ event.registration_deadline.strftime('%d.%m.%Y') }}
            </div>
            <div class="meta-item">
                <strong>üë• –£—á–∞—Å–Ω–∏–∫—ñ–≤:</strong> {{ event.current_participants }}/{{ event.max_participants }}
            </div>
            {% if rating_data.count > 0 %}
                <div class="meta-item">
                    <strong>‚≠ê –†–µ–π—Ç–∏–Ω–≥:</strong> {{ "%.1f"|format(rating_data.avg_rating) }} ({{ rating_data.count }} –æ—Ü—ñ–Ω–æ–∫)
                </div>
            {% endif %}
        </div>
        
        <div class="event-description">
            <h2>–û–ø–∏—Å –ø–æ–¥—ñ—ó</h2>
            <p>{{ event.description }}</p>
        </div>
        
        {% if session.user_id %}
            <div class="event-actions">
                {% if not is_registered and event.status == 'upcoming' %}
                    {% if event.current_participants < event.max_participants %}
                        <form method="POST" action="{{ url_for('register_for_event', event_id=event.id) }}">
                            <button type="submit" class="btn btn-success">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è –Ω–∞ –ø–æ–¥—ñ—é</button>
                        </form>
                    {% else %}
                        <p class="alert alert-warning">–í–∏–±–∞—á—Ç–µ, –≤—Å—ñ –º—ñ—Å—Ü—è –∑–∞–π–Ω—è—Ç—ñ</p>
                    {% endif %}
                {% elif is_registered %}
                    <div class="alert alert-success">–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ –Ω–∞ —Ü—é –ø–æ–¥—ñ—é</div>
                    <form method="POST" action="{{ url_for('cancel_registration', event_id=event.id) }}">
                        <button type="submit" class="btn btn-danger">–°–∫–∞—Å—É–≤–∞—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é</button>
                    </form>
                {% endif %}

                {% if session.role == 'admin' or (session.user_id and event.organizer_id == session.user_id) %}
                    <a href="{{ url_for('edit_event', event_id=event.id) }}" class="btn btn-secondary">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ–¥—ñ—é</a>
                    <a href="{{ url_for('event_participants', event_id=event.id) }}" class="btn btn-info">–£—á–∞—Å–Ω–∏–∫–∏</a>
                {% endif %}
            </div>
        {% else %}
            <p class="alert alert-info">
                <a href="{{ url_for('login') }}">–£–≤—ñ–π–¥—ñ—Ç—å</a>, —â–æ–± –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è –Ω–∞ –ø–æ–¥—ñ—é
            </p>
        {% endif %}
        
        <div class="comments-section">
            <h2>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ ({{ comments|length }})</h2>
            
            {% if session.user_id %}
                <form method="POST" action="{{ url_for('add_comment', event_id=event.id) }}" class="comment-form">
                    <div class="form-group">
                        <textarea name="comment_text" rows="3" placeholder="–ó–∞–ª–∏—à–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</button>
                </form>
            {% endif %}
            
            <div class="comments-list">
                {% for comment in comments %}
                    <div class="comment">
                        <div class="comment-header">
                            <strong>{{ comment.full_name }}</strong>
                            <span class="comment-date">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        <p>{{ comment.comment_text }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
